; ÎÁÈÏÄÉÔÓÑ × ÂÁÎËÅ 1

	.PHASE  SYSADDR

IO_BYTE EQU	3
SIGKILL equ	9	; kill driver
SIGHUP	equ	1       ; refresh driver

BDOS1:  LD      (RG_DE),DE
	LD	A,E
	LD      (RG_E),A
	LD      HL,0
	LD      (EXITRG_A),HL
	LD	A,B
	LD      (CALSEGM),A     ; ÷ùúù÷áàýéê óåçíåîô
	LD      B,4
MKADDR: RRA
	RR      H
	DJNZ    MKADDR
	LD      (CALADDR),HL    ; ÷ùúù÷áàýéê áäòåó
	AND     0FH
	LD      (RG_B),A        ; ÷ùúù÷áàýéê âáîë
	LD      (RG_SP),SP
	LD      SP,(STK_PTR)

	ld	a, DEFAULT_DISK
	LD      (ACT_DISK),A; ÔÅËÕÝÉÊ ÄÉÓË
	xor	a
;(ÉÓÐ ×ÒÅÍÅÎÎÏ ÐÒÉ ÏÐÅÒÁÃÉÉ Ó Ñ×ÎÏ ÕËÁÚÁÎÎÙÍ ÄÉÓËÏÍ × FCB )
	LD      (DISK_FN),A ; ÓÂÒ. ÆÌÁÇ - ÄÉÓËÏ×ÁÑ ÏÐÅÒÁÃÉÑ
			    ; ( ÉÓÐ. ÐÒÉ EXIT_ST )
	LD      (RETOK),A   ; ÓÂÒ. ÆÌÁÇ - ×ÏÚ×ÒÁÔ FCB
	LD      (FCB_DRIVE),A
	LD      (PATHFLG),A
	LD      (ISCREAT),A

	LD      A,C
	LD      (FUNCNUM),A
	CP      29H
	LD      HL,EXIT_ST   ; ÔÏÞËÁ ×ÏÚ×ÒÁÔÁ ÓÔÁÒÙÈ Æ-ÃÉÊ
	JR      C,NOPUSH
	LD      HL,RETURN
NOPUSH: PUSH    HL

	CP      100
	JP      NC,EMMFUNC

	LD      C,E
	LD      HL,BDOSF     ; ÔÁÂÌÉÃÁ ×ÅËÔÏÒÏ× Æ-ÃÉÊ BDOS
	LD	E,A
	LD      D,0
	ADD	HL,DE
	ADD	HL,DE
	LD	E,(HL)
	INC	HL
	LD      D,(HL)
	LD      HL,(RG_DE)
	EX      DE,HL
	JP	(HL)
;
; ÔÁÂÌÉÃÁ ×ÅËÔÏÒÏ× Æ-ÃÉÊ BDOS
BDOSF:  DW      RESTART ;  0 - "ÇÏÒÑÞÉÊ ÓÔÁÒÔ"
	DW      F1      ;  1 - ××ÏÄ ÓÉÍ×ÏÌÁ Ó ËÏÎÓÏÌÉ
	DW      OUTPUT  ;  2 - ×Ù×ÏÄ ÓÉÍ×ÏÌÁ ÎÁ ËÏÎÓÏÌØ
	DW      F3      ;  3 - ××ÏÄ ÓÉÍ×ÏÌÁ Ó ÌÏÇÉÞÅÓËÏÇÏ
			;      ÕÓÔÒÏÊÓÔ×Á RDR
	DW      @AUXOUT ;  4 - ×Ù×ÏÄ ÓÉÍ×ÏÌÁ ÎÁ ÌÏÇÉÞÅÓËÏÅ
			;      ÕÓÔÒÏÊÓÔ×Ï PUN
	DW      @OUT_PRNT;  5 - ×Ù×ÏÄ ÓÉÍ×ÏÌÁ ÎÁ ÌÏÇÉÞÅÓËÏÅ
			;      ÕÓÔÒÏÊÓÔ×Ï LST
	DW      F6      ;  6 - ÐÒÑÍÏÊ ××ÏÄ/×Ù×ÏÄ ÓÉÍ×ÏÌÁ
			;      Ó ËÏÎÓÏÌÉ
	DW      F7      ;  7 - ÐÏÌÕÞÉÔØ ÂÁÊÔ ÎÁÚÎÁÞÅÎÉÑ
			;      ÕÓÔÒÏÊÓÔ× (âîõ)
	DW      F8      ;  8 - ÕÓÔÁÎÏ×ÉÔØ âîõ
	DW      F9      ;  9 - ×Ù×ÏÄ ÓÔÒÏËÉ ÓÉÍ×ÏÌÏ×
	DW      FA      ; 10 - ÞÔÅÎÉÅ ËÏÎÓÏÌØÎÏÇÏ ÂÕÆÅÒÁ
	DW      FB      ; 11 - ÏÐÒÏÓ ÓÔÁÔÕÓÁ ËÏÎÓÏÌÉ
	DW      FC      ; 12 - ðïìõþåîéå îïíåòá ÷åòóéé CPM
			;    ÷ HL: H=0 - óP/M , H=11 - MP/M
			;    L=20...2F îá CP/M 2.0 ... 2.15
	DW      FD      ; 13 - óâòïó äéóëï÷ïê óéóôåíù
	DW      FE      ; 14 - ÁËÔÉ×ÉÚÁÃÉÑ ÄÉÓËÁ
	DW      FF      ; 15 - ÏÔËÒÙÔÉÅ ÆÁÊÌÁ
	DW      F10     ; 16 - ÚÁËÒÙÔÉÅ ÆÁÊÌÁ
	DW      F11     ; 17 - ðïéóë ðåò÷ïçï - ðïéóë æáêìá
			;      ÷ ëáôáìïçå äéóëá
	DW      F12     ; 18 - ðïéóë óìåäõàýåçï - ôï öå
			;      þôï é 17 îï ó ôåëõýåçï
	DW      F13     ; 19 - ÓÔÉÒÁÎÉÅ ÆÁÊÌÁ
	DW      F14     ; 20 - ÐÏÓÌÅÄÏ×ÁÔÅÌØÎÏÅ ÞÔÅÎÉÅ
	DW      F15     ; 21 - ÐÏÓÌÅÄÏ×ÁÔÅÌØÎÁÑ ÚÁÐÉÓØ
	DW      F16     ; 22 - ÓÏÚÄÁÔØ ÆÁÊÌ
	DW      F17     ; 23 - ÐÅÒÅÉÍÅÎÏ×ÁÔØ ÆÁÊÌ
	DW      F18     ; 24 - ÐÏÌÕÞÉÔØ ×ÅËÔÏÒ ÚÁÒÅÇÉÓÔÒÉ-
			;      ÒÏ×ÁÎÎÙÈ ÄÉÓËÏ×
	DW      F19     ; 25 - ÐÏÌÕÞÉÔØ ÎÏÍÅÒ ÁËÔ. ÄÉÓËÁ
	DW      F1A     ; 26 - ÕÓÔÁÎÏ×ÉÔØ ÁÄÒÅÓ DMA
	DW      F1B     ; 27 - ðïìõþåîéå áäòåóá òáúíåýåîéñ
			;      ÷ HL
	DW      F1C     ; 28 - ÚÁÐÉÓÁÔØ ËÌÀÞ ÚÁÝÉÔÙ ÄÉÓËÁ
	DW      F1D     ; 29 - ÐÏÌ. ×ÅËÔÏÒ R/O ÄÌÑ ÄÉÓËÏ×
	DW      F1E     ; 30 - ÕÓÔÁÎÏ×ÉÔØ ÉÎÄÉËÁÔÏÒ ÄÏÓÔÕ-
			;      ÐÁ ÆÁÊÌÁ
	DW      F1F     ; 31 - ðïìõþåîéå áäòåóá âìïëá ðáòá-
			;      íåôòï÷ äéóëá ÷ HL
	DW      F20     ; 32-  õóôáîï÷ëá/ðïìõþåîéå ëïäá
			;      ðïìøúï÷áôåìñ
	DW      F21     ; 33 - ÐÒÑÍÏÅ ÞÔÅÎÉÅ
	DW      F22     ; 34 - ÐÒÑÍÁÑ ÚÁÐÉÓØ
	DW      F23     ; 35 - ×ÙÞÉÓÌÉÔØ ÒÁÚÍÅÒ ÆÁÊÌÁ
	DW      F24     ; 36 - ÕÓÔÁÎÏ×ÉÔØ ÎÏÍÅÒ ÚÁÐÉÓÉ ÄÌÑ
			;      ÐÒÑÍÏÇÏ ÄÏÓÔÕÐÁ
	DW      F25     ; - , (ÎÏ ËÁËÁÑ-ÔÏ ÆÕÎËÃÉÑ ÅÓÔØ)
	DW      F26     ; -  RET
	DW      F27     ; -  RET
	DW      F28     ; 40 - ÐÒÑÍÁÑ ÚÁÐÉÓØ ÎÁ ÏÂÎÕÌÅÎÎÙÊ
			;      ÂÌÏË
;
; îï÷ùå äéóëï÷ùå æõîëãéé
;
	DW      FN29    ; ÷ íáóóé÷ ó áäòåóïí ÷ DE ÷ ôåëõýåí
			; âáîëå ÷ïú÷òáý.16 óéí÷.íåôëá äéóëá
	DW      FN2A    ; éú íáóóé÷á (ðï DE) îá äéóë úáðéó.
			; 16-é óéí÷ïìøîáñ íåôëá äéóëá
	DW      FN2B    ; ÷ íáóóé÷ (ðï DE) ÷ïú÷òáý. 16 óéí÷.
			; éíñ ôåëõýåçï àúåòá
	DW      FN2C    ; ôåëõýåíõ àúåòõ õóôáîá÷ì. îï÷ïå éíñ
			; éú íáóóé÷á (ðï DE) - 16 óéí÷.
	DW      FN2D    ; õóôáîï÷ëá àúåòá ðï éíåîé éú íáóé÷á
			; (ðï DE)
	DW      FN2E    ; ðïìõþéôø éú âõæåòá ôéíðìåôá óôòïëõ
			; ÷ íáóóé÷ (ðï DE).
	DW      FN2F    ; äïâá÷éôø óôòïëõ ÷ âõæåò ôéíðìåôá
			; éú íáóóé÷á (ÐÏ DE).
	DW      FN30    ; ðïìõþéôø éú âõæåòá ðïäíåî óôòïëõ
			; ÷ íáóóé÷ (ðï DE).
	DW      FN31    ; äïâá÷éôø óôòïëõ ÷ âõæåò ðïäíåî
			; éú íáóóé÷á (ÐÏ DE).
	DW      FN32    ; ðïìõþéôø óôòïëõ éú BAT-âõæåòá ÷
			; íáóóé÷ (ðï DE).íáóé÷ óïëòáýáåôóñ
	DW      FN33    ; äïâá÷éôø óôòïëõ ÷ BAT-âõæåò éú
			; íáóóé÷á (ðï DE).
	DW      FN34    ; ðïìõþéôø äáôõ óïúäáîéñ æáêìá.
			; ÷èïä: DE=ADDR(FCB).
	DW      FN35    ; õóôáîï÷éôø äáôõ óïúäáîéñ æáêìá.
			; ÷èïä: DE=ADDR(FCB).
	DW      FN36    ; ðïìõþéôø óôòïëõ òåçóôòáãéé äéóëï÷
			; (16 âáêô) ÷ íáóóé÷ (ðï DE)
	DW      FN37    ; õóôáîï÷éôø/ðïìõþéôø PATH-USER
			; ÷èïä: òåç.å=(0..0Fî)/0FFî
	DW      FN38    ; äï÷åóïë K FN34
	DW      FN39    ; äï÷åóïë ë FN35
	DW      FN3A    ; ðïìõþéôø áäòåó DMA
; >>>>>>
; ×Ù×ÏÄ "BAD SECTOR"
R_BADS: LD      HL,MSG_BADS
	CALL    FATAL
	CALL    INPUT
	CP      3               ; ××ÅÄÅÎÏ ^C
	JR      Z,RESTART
	DB      31H             ; LD  SP,...
ERRSTACK:DW     0
	XOR     A
	RET

; ×Ù×ÏÄ "SELECT"
R_SELD: LD      HL,MSG_SELD
	JR      ALLERR

; ×Ù×ÏÄ "DISK R/O"
R_DSKRO:LD      HL,MSG_DSKRO
	JR      ALLERR

; ×Ù×ÏÄ "FILE R/O"
R_FLRO: LD      HL,MSG_FLRO
ALLERR: CALL    FATAL
RESTART:LD      HL,WARMSTART
	JP      TOBIOS2

MSG_ERR:DEFB    13,10,'BDOS ERROR ON '
DRV_ERR:DEFB    ' : $'
MSG_BADS:DEFB   'BAD SECTOR$'
MSG_SELD:DEFB   'Select$'
MSG_FLRO:DEFB   'File '
MSG_DSKRO:DEFB  'R/O$'
;MSG_CRLF:DEFB   10,13,36
;
FATAL:  PUSH    HL
;	LD      DE,MSG_CRLF
;	CALL    PRINTT
	LD      A,(ACTDISK)
	ADD     A,'A'
	LD      (DRV_ERR),A
	LD      DE,MSG_ERR
	CALL    PRINTT
	POP     DE
PRINTT: LD      A,(DE)
	CP      '$'
	RET     Z
	PUSH    DE
	LD      C,A
	CALL    @CONOUT
	POP     DE
	INC     DE
	JR      PRINTT
; <<<<<<<
;

; ×Ù×ÏÄ "BAD SECTOR"
; üôï ÷ BIOS
P_BADS: LD      HL,BERR1
	JR      ISERROR

; ×Ù×ÏÄ "SELECT"
P_SELD: LD      HL,BERR2
	JR      ISERROR

; ×Ù×ÏÄ "DISK R/O"
P_DSKRO:LD      HL,BERR3
	JR      ISERROR

; ×Ù×ÏÄ "FILE R/O"
P_FLRO: LD      HL,BERR4
ISERROR:LD      (ERRSTACK),SP
	LD      SP, MOVESP
	CALL    BLDB2
	PUSH    BC              ; B=BANK
	INC     HL
	CALL    BLDB2
	LD      C,B
	PUSH    BC              ; C=L.ADDR
	INC     HL
	CALL    BLDB2           ; B=H.ADDR
	POP     HL              ; L=L.ADDR
	LD      H,B
	POP     AF
	JP      BJMP
;
BLDB2:  LD      A,TPAPAGE
	JP      BLDB
;
; Æ-ÃÉÑ 1 (××ÏÄ Ó ËÏÎÓÏÌÉ Ó ÜÈÏÐÅÞÁÔØÀ)
F1:     CALL    INPUT           ; !!!
	CP      ' '
	JP      C,SETEXITRG_A
	LD	C,A
	CALL    XOUTPUT
	JP      SETEXITRG_A
;
;F6:     LD      A,C
;	INC     A
;	JP      Z,F6NEXT
;	INC     A
;	JP      Z,FB
;	LD      HL,CONOUT        ; BIOS+0CH
;	JP      TOBIOS2
;
;F6NEXT: CALL    @CONSTAT      ; BIOS+6
;	OR      A
;	CALL    NZ,@CONIN     ; BIOS+9
;	JP      SETEXITRG_A
;
F9:     EX      DE,HL
	LD      A,(RG_B)
	CALL    BLDB
	LD      A,B
	INC     HL
	CP      '$'
	RET	Z
	LD	C,A
	PUSH    HL
	CALL    OUTPUT
	POP     HL
	JR      F9+1

; Æ-ÃÉÑ 0Ah ××ÏÄ ÓÔÒÏËÉ Ó ËÏÎÓÏÌÉ × ÂÕÆÅÒ
; óïá÷ôïò: á.âáìäéî
FA:     CALL    GETSTRING       ; üôï ÷ BIOS2.MAC
	DEC     HL              ; HL=NEWBUFF
	XOR     A
	LD      (FL0),A
	LD      E,A             ; E=óëïìøëï ÷÷åäåîï
	LD      B,A             ; ÷=ðïúéãéñ ëõòóïòá
	LD      D,(HL)          ; × D ÍÁËÓ. ÄÌÉÎÁ ÓÔÒÏËÉ
	INC     HL
	PUSH    HL              ; HL=NEWBUFF+1
; × ÓÔÅËÅ ÕËÁÚÁÔÅÌØ ÎÁ ÒÅÁÌØÎÕÀ ÄÌÉÎÕ ÓÔÒÏËÉ
	LD      A,(VALUE)
	RLCA
	JR      NC,BIT7RES
	LD      A,(HL)
	OR      A
	JR      Z,BIT7RES
	LD      E,A
	INC     HL
	PUSH    DE
	CALL    SHOWLEFT
	POP     DE
	LD      B,E
LCYCL:  CALL    CLEFT
	DJNZ    LCYCL
	DEC     HL
BIT7RES:INC     HL
; HL ÕËÁÚÙ×ÁÅÔ ÎÁ ÒÁÂÏÞÕÀ ÞÁÓÔØ ÂÕÆÅÒÁ ÓÔÒÏËÉ
LOOP_INP:
	PUSH    HL
	PUSH    DE
	PUSH    BC
	LD      A,E
	LD      (FN10QN),A
	CALL    INPUT           ; XINPUT
	POP     BC
	POP	DE
	POP     HL              ; !!!
	LD      C,A             ; ÓÏÈÒ. ÄÁÎÎÙÅ × C
	CP      8               ; ËÌ
	JP      Z,CRLEFT
	CP      13              ; ×Ë
	JR      Z,CRCR
	CP      10              ; ÐÓ
	JR      Z,CRCR
	CP      7Fh             ; del
	JP      Z,CRDEL
	CP      4               ; ËÐ
	JP      Z,CRNEXT
	CP      27              ; esc
	JP      Z,CRESC
	CP      5               ; ËÐ
	JP      Z,CRUP
	CP      24              ; ËÎ
	JP      Z,CRDOWN
	CP      3               ; ^C
	CALL    Z,CRCTRLC

	LD      A,(VALUE)
	RLCA
	JR      NC,BIT7RSS
	LD      A,C
	CP      ' '
	JR      C,LOOP_INP
BIT7RSS:
	LD      A,D
	OR	A
	JR      Z,LOOP_INP ; ÉÇÎÏÒ. ××ÏÄÁ, ÂÕÆÅÒ ÚÁÐÏÌÎÅÎ
	DEC     D       ; ÉÎÁÞÅ ÕÍÅÎØÛÉÔØ ÓÞÅÔÞÉË
	LD	A,E
	SUB     B
	INC	A
			; A = E - B + 1
	PUSH    BC
	LD	B,A
FA_L0:  LD      A,C
	CALL    CTRL_OUT
	LD      C,(HL)
	LD      (HL),A
	INC     HL
	DEC	B
	JR      NZ,FA_L0
	POP     BC

	LD      A,E
	SUB     B
	JR      Z,FA_L1

FA_L2:  PUSH    AF
	CALL    CLEFT
	POP     AF
	DEC	A
	JR      NZ,FA_L2

FA_L1:  INC     E
	INC     B
	JR      LOOP_INP
;
CRCTRLC:LD      A,E
	OR	A
	RET     NZ
	LD      A,(VALUE)
	RLCA
	RET     C
	LD      HL,VALUE
	RES     3,(HL)  ; óâòïóéôø ðòéúîáë òáâïôù ÷ CCP
	JP      RESTART

; ÷Ù×ÅÓÔÉ ÏÓÔÁÔÏË ÂÕÆÅÒÁ (ÓÐÒÁ×Á ÐÏÓÌÅ ËÕÒÓÏÒÁ)
SHOWLEFT:
	LD      A,E
	SUB     B
	LD	C,A
	RET	Z
FA_L3:  LD      A,(HL)
	CALL    CTRL_OUT
	INC     HL
	INC	B
	DEC	C
	JR      NZ,FA_L3
	RET
;
CRCR:   CALL    SHOWLEFT
	LD      C,13
	LD      (HL),C
	CALL    XOUTPUT
	POP     HL
	LD      (HL),E

	LD      A,E
	OR	A
	JR      Z,EXITFA ; ÷ùèïä, åóìé ðõóôïê âõæåò

	LD      A,(VALUE)
	AND     8
	JR      Z,EXITFA ; ÷ùèïä, åóìé ÷ùúï÷ îå éú CCP

	CALL    @SAVETIM ; úáðéóáôø óôòïëõ ÷ âõæåò ôéíðìåôá
EXITFA: LD      A,(RG_B)        ; ëõäá
	LD      HL,(RG_DE)
	EXX
	EX      AF,AF'
	LD      HL,NEWBUFF
	LD      BC,(FALEN)
BLDIRF1:LD      A,WORKPAGE	; ïôëõäá
	JP      BLDIR           ; !!!
;
; ESC - óôåòåôø ÷óà óôòïëõ
CRESC:  LD      A,E
	OR	A
	JP      Z,LOOP_INP
	CALL    SHOWLEFT
FA_L8:  CALL    KILLSYM
	JR      NZ,FA_L8
	JP      LOOP_INP

; ëõòóïò ÷ìå÷ï
CRLEFT: LD      A,B
	OR	A
	JP      Z,LOOP_INP
	DEC	B
	CALL    CLEFT
	JP      LOOP_INP
;
CLEFT:  LD      C,8                     ; ËÌ
	DEC     HL
	CALL    XOUTPUT
	LD      A,(HL)
	CP      ' '
	CALL    C,XOUTPUT
	RET

; ëõòóïò ÷ðòá÷ï
CRNEXT: LD      A,E
	CP	B
	JP      Z,LOOP_INP

	LD      C,24          ; ËÐ
	CALL    XOUTPUT
	LD      A,(HL)
	CP      ' '
	CALL    C,XOUTPUT
	INC     HL
	INC	B
	JP      LOOP_INP

; DELETE
CRDEL:  LD      A,B
	OR	A
	JP      Z,LOOP_INP
	CALL    KILLSYM
	JP      LOOP_INP

; õäáìéôø óéí÷ïì ÷ óôòïëå
KILLSYM:LD      C,8
	DEC     HL
	CALL    XOUTPUT
	LD      A,(HL)
	CP      ' '
	CALL    C,XOUTPUT
	PUSH    AF
	LD	A,E
	SUB	B
	LD	C,A
	JR      Z,FA_L9
FA_L10: INC     HL
	LD      A,(HL)
	DEC     HL
	LD      (HL),A
	INC     HL
	CALL    CTRL_OUT
	DEC	C
	JR      NZ,FA_L10
FA_L9:  POP     AF
	LD      C,' '
	CALL    XOUTPUT
	CALL    C,XOUTPUT
	LD      C,8
	CALL    XOUTPUT
	CALL    C,XOUTPUT
	LD	A,E
	SUB	B
	JR      Z,FA_L11
FA_L19: PUSH    AF
	CALL    CLEFT
	POP     AF
	DEC	A
	JR      NZ,FA_L19
FA_L11: DEC     E
	INC	D
	DEC	B
	RET

; ëõòóïò ÷÷åòè - ðïìõþéôø óôòïëõ éú âõæåòá ôéíðìåôá
CRUP:   LD      A,(FL1)
	OR	A
	JP      Z,LOOP_INP ; ÷ùèïä, âõæåò ôéíðìåôá ðõóôïê

	LD      A,(VALUE)
	AND     8
	JP      Z,LOOP_INP  ; ðåòåèïä, åóìé ÷ùúï÷ îå éú CCP
	JR      FA_DL13
;
CRDOWN: LD      A,(FL1)
	OR	A
	JP      Z,LOOP_INP ; ÷ùèïä, âõæåò ôéíðìåôá ðõóôïê

	LD      A,(VALUE)
	AND     8
	JP      Z,LOOP_INP  ; ðåòåèïä, åóìé ÷ùúï÷ îå éú CCP
	LD      A,(FL0)
	CP      2
	JR      NC,FA_L14   ; IF FL0>1
	LD      A,(FL1)     ; õóô. ÷ òåç. á îïíåò óôòïëé
	JR      FA_L13      ; éú âõæåòá ôéíðìåôá
FA_L14: DEC     A
FA_L13: CP      2
	JR      NC,FA_CL14
	LD      A,(FL1)     ; õóô. ÷ òåç. á îïíåò óôòïëé
	JR      FA_CL13     ; éú âõæåòá ôéíðìåôá
FA_CL14:DEC     A
FA_CL13:LD      (FL0),A     ; úáîåóôé ÷ FL0 îïíåò óôòïëé

FA_DL13:                    ; ôéíðìåôá
	LD      A,E
	OR	A
	JR      Z,FA_L15
	CALL    SHOWLEFT
FA_L16: CALL    KILLSYM     ; õâòáôø óôáòõà óôòïëõ
	JR      NZ,FA_L16
FA_L15: LD      A,B
	POP     HL          ; HL - õëáúáôåìø îá STRING SIZE

	CALL    @GETTIM     ; ðïìõþéôø óôòïëõ éú âõæåòá

	DEC     HL
	LD      A,(HL)
	SUB     E           ; A=MAX-REAL
	LD      D,A         ; õóôáîï÷éôø òåç. D,E,HL
	INC     HL

	PUSH    HL
	INC     HL

	CALL    SHOWLEFT    ; ÷ùäáôø îï÷õà óôòïëõ îá üëòáî
	JP      LOOP_INP
;
XOUTPUT:PUSH    HL
	PUSH    DE
	PUSH    BC
	PUSH    AF
	CALL    OUTPUT
	POP	AF
	POP     BC
	POP	DE
	POP     HL
	RET

; ×Ù×ÏÄ ÓÉÍ×ÏÌÁ ÉÚ C, ÅÓÌÉ ÍÅÎØÛÅ 20h, ÔÏ ×Ù×ÏÄ Ó '^'
CTRL_OUT:
	PUSH    BC
	PUSH    AF
	CP      ' '
	JR      NC,C_OUT0
	PUSH    AF
	LD      C,'^'
	CALL    XOUTPUT
	POP	AF
	ADD     A,40h
C_OUT0: LD      C,A
	CALL    XOUTPUT
	POP	AF
	POP	BC
	RET
;
OUTPUT: PUSH    BC
	LD      HL,CONOUT        ; BIOS+0Ch
	CALL    TOBIOS2
	POP     BC
	LD      A,(FL_PRINT)
	OR	A
	RET     Z
	JP      @OUT_PRNT        ; BIOS+0Fh
;
INPUT:  CALL    @CONIN           ; BIOS+9
	CP      16               ; ^P
	RET	NZ
	LD      A,(FL_PRINT)
	CPL
	LD      (FL_PRINT),A
	JR      INPUT
;
; æÕÎËÃÉÑ 3 - ××ÅÓÔÉ ÂÁÊÔ Ó ÕÓÔÒ. ××ÏÄÁ
F3:     CALL    @AUXIN
	JP      SETEXITRG_A

; æÕÎËÃÉÑ 7 - ÐÏÌÕÞÉÔØ ÂÁÊÔ ÎÁÚÎÁÞÅÎÉÑ ÕÓÔÒÏÊÓÔ×
F7:     LD      HL, IO_BYTE
	CALL    BLDB2
	LD      A,B
SETEXITRG_A:
	LD      (EXITRG_A),A
F6:
FB:
F26:
F27:    RET

; æÕÎËÃÉÑ 8 - ÕÓÔÁÎÏ×ÉÔØ ÂÁÊÔ ÎÁÚÎÁÞÅÎÉÑ ÕÓÔÒÏÊÓÔ×
F8:     LD      HL, IO_BYTE
	LD      B,E
BSTB2:	LD      A,TPAPAGE
	JP      BSTB
;
;FB:     CALL    @CONSTAT         ; BIOS+6
;	JP      SETEXITRG_A
;
; ÕÓÔÁÎÏ×ÉÔØ ÑÞÅÊËÕ, × ËÏÔÏÒÏÊ ÈÒÁÎÉÔÓÑ ÚÎÁÞÅÎÉÅ ÒÇ. A ÄÌÑ
; ÔÅÈ Æ-ÃÉÊ, ËÏÔÏÒÙÅ ×ÏÚ×ÒÁÝÁÀÔ ×ÙÈÏÄÎÏÊ ÐÁÒÁÍÅÔÒ × ÒÇ. A
;
SETEXRGA_1:
	LD      A,1
	JR      SETEXITRG_A

COPY:   INC     C               ; ðïèïöå îá LDIR
ACF50:	DEC	C
	RET	Z
	LD	A,(DE)
	LD	(HL),A
	INC	DE
	INC	HL
	JP      ACF50
;
ACF59:  LD      A,(ACTDISK)
	LD	C,A
	CALL    @SELDISK        ; (HL)=DPH
	LD	A,H
	OR	L
	RET	Z
;
	ld	de,XLTPT	; bigfiles
	ld	bc,2
	ldir
	LD      (SYSW1),HL      ; õë-ìø îá óìõöåâ. óìï÷ï 1
	ld	c,6
	add	hl,bc
	ld	de,DIRBPT
	ld	c,8
	ldir
	ld	hl,(DPB_ADR)
	ld	de,DPBCOPY
	ld	c,0FH
	ldir			; bigfiles
;	LD      E,(HL)
;	INC	HL
;	LD      D,(HL)          ; (DE)=XLT
;	INC	HL
;	LD      (SYSW1),HL      ; õë-ìø îá óìõöåâ. óìï÷ï 1
;	INC	HL
;	INC	HL
;	LD      (SYSW2),HL      ; --"--"--"--"--"--"--"- 2
;	INC	HL
;	INC	HL
;	LD      (SYSW3),HL      ; --"--"--"--"--"--"--"- 3
;	INC	HL
;	INC	HL
;	EX      DE,HL           ; DE=áäò. õë-ìñ îá DIRBUF
;	LD      (XLTPT),HL      ; õë-ìø îá XLT
;	LD      HL,DIRBPT
;	LD      C,8
;	CALL    COPY            ; âåòåí ðáòáíåôòù éú DPH
;	LD      HL,(DPB_ADR)
;	EX	DE,HL
;	LD      HL,DPBCOPY
;	LD      C,0FH
;	CALL    COPY            ; ëïðéñ DPB äéóëá
	LD      HL,(DSM)
	LD	A,H
	LD      HL,DSM255
	LD      (HL),0FFH
	OR	A
	JR      Z,ACF9D
	LD      (HL),0
; DSM255 = FF, ÅÓÌÉ ÏÂ'ÅÍ ÄÉÓËÏ×ÏÄÁ < 256 ÇÒÕÐÐ
; DSM255 = 00, ÅÓÌÉ ÏÂ'ÅÍ ÄÉÓËÏ×ÏÄÁ > 255 ÇÒÕÐÐ

ACF9D:  xor	a	; LD	A,0FFH          ; ÕÓÔ. Z=0 - ÏË!
	dec	a	; OR	A
	RET
;
HOME	EQU	@SETTR00		; bigfiles
;HOME:   CALL    @SETTR00
;	XOR	A
;	LD      HL,(SYSW2)
;	LD	(HL),A
;	INC	HL
;	LD	(HL),A
;	LD      HL,(SYSW3)
;	LD	(HL),A
;	INC	HL
;	LD	(HL),A
;	RET
;
RDSEC:  CALL    @READSEC
	JR      COMMSEC
;
WRSEC:  CALL    @WRITESEC
COMMSEC:OR      A
	CALL    NZ,P_BADS
	RET
;
; ïâóìõçá òáóûéòåîîïê ðáíñôé - æ. 100..114
;
EMMFUNC:PUSH    AF              ; A=îïíåò æõîëãéé
	ld      a,(CALSEGM)
	ld      e,a
	call    GETSEGM
	ld      (DRVCODE),a     ; ËÏÄ ×ÙÚÙ×ÁÀÝÅÊ ÐÒÏÇÒÁÍÍÙ
	POP     AF
	LD      C,A
	ld      hl,FUNCTAB-200
	ld      b,0
	cp      100
	jr      z,NEXT3
	cp      105
	jr      nc,NEXT3
	ld      a,d
	or      a               ; Æ-ÉÉ 101..104 ÎÅÌØÚÑ
	jp      z,BADRET        ; ×ÙÚÙ×ÁÔØ Ó ÒÅÇ. D=0
NEXT3:  add     hl,bc
	add     hl,bc
	ld      e,(hl)
	inc     hl
	ld      d,(hl)
	ld      hl,(RG_DE)
	ex      de,hl
	ld      a,(RG_B)
	jp      (hl)
;
FUNCTAB:DW      F100
	DW      F101
	DW      F102
	DW      F103
	DW      F104
	DW      F105
	DW      F106
	DW      F107
	DW      F108
	DW      F109
	DW      F110
	DW      F111
	DW      F112
	DW      F113
	DW      F114
	DW      F115
;
VMEM1:	DB	1	; memory allocation method: 0=upper_to_lower, 1=lower_to_upper	
;
; õÓÔÁÎÏ×ËÁ ÁÄÒÅÓÁ REW ÉÚ DE. âÁÎË ÓÞÉÔÁÅÔÓÑ Á×ÔÏÍÁÔÉÞÅÓËÉ.
;
F100:   ld      (REWADDR),de
;        ld      a,(RG_B)
	ld      (REWBANK),a
	ret
;
; ëÏÐÉÒÏ×ÁÎÉÅ ÓÅÇÍÅÎÔo× × ÂÕÆÅÒ.
; ÷ÈÏÄ: D=ËÏÌÉÞÅÓÔ×Ï ÓÅÇÍÅÎÔÏ×, E=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ. ÷ÙÈÏÄ:
; A = 0, ÅÓÌÉ ÎÏÒÍÁÌØÎÏ, A = FF ÅÓÌÉ ÓÅÇÍÅÎÔ ÏÔÓÕÔÓÔ×ÕÅÔ
;
F101:   xor     a
F101A:  push    de
	push    af
	push    af
	call    GETSEGM
	cp      0fh
	jp      z,BADRET
	ex      af,af'
	exx
	ld      bc,(REWADDR)    ; ËÕÄÁ
	pop     hl              ; h=A
	ld      l,0
	add     hl,hl
	add     hl,hl
	add     hl,hl
	add     hl,hl
	add     hl,bc           ; hl=(REWADDR)+A*1000h
	ld      a,(REWBANK)
	ex      af,af'
	exx
	call    f112		; B=0
	ld      a,l
	ld      l,b		; ,0             ; ÏÔËÕÄÁ
	ld      bc,1000h        ; ÓËÏÌØËÏ
	call    BLDIR
	pop     af
	pop     de
	inc     e
	inc     a
	cp      d
	jr      c,F101A
	xor     a
	ret
;
;   úÁÐÉÓØ ÓÅÇÍÅÎÔÏ× ÉÚ ÂÕÆÅÒÁ ÏÂÍÅÎÁ.
; ÷ÈÏÄ: D=ËÏÌÉÞÅÓÔ×Ï ÓÅÇÍÅÎÔÏ×, E=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ. ÷ÙÈÏÄ:
; A = 0, ÅÓÌÉ ÎÏÒÍÁÌØÎÏ, A = FF ÅÓÌÉ ÓÅÇÍÅÎÔ ÏÔÓÕÔÓÔ×ÕÅÔ
;
F102:   xor     a
F102A:  push    de
	push    af
	push    af
	call    GETSEGM
	cp      0fh
	jp      z,BADRET
	ex      af,af'
	exx
	ld      de,(RG_DE)
	call    f112		; B=0
	ld      a,l
	ld      l,b		; ,0     ; ËÕÄÁ
	ex      af,af'
	exx
	ld      bc,(REWADDR)    ; ÏÔËÕÄÁ
	pop     hl              ; h=A
	ld      l,0
	add     hl,hl
	add     hl,hl
	add     hl,hl
	add     hl,hl           ; hl=(REWADDR)+A*1000h
	add     hl,bc
	ld      a,(REWBANK)
	ld      bc,1000h        ; ÓËÏÌØËÏ
	call    BLDIR
	pop     af
	pop     de
	inc     e
	inc     a
	cp      d
	jr      c,F102A
	xor     a
	ret
;
;   òÅÚÅÒ×ÉÒÏ×ÁÎÉÅ N ÐÏÓÌÅÄÏ×ÁÔÅÌØÎÙÈ ÓÅÇÍÅÎÔÏ×.
; ÷ÈÏÄ: D=ËÏÌÉÞÅÓÔ×Ï ÓÅÇÍÅÎÔÏ×
;       E=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ (0FFh ÅÓÌÉ ÌÀÂÏÊ)
; ÷ÙÈÏÄ: A=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ, ÅÓÌÉ ÒÅÚÅÒ×ÉÒÏ×ÁÎÉÅ ÐÒÏÛÌÏ
;        ÎÏÒÍÁÌØÎÏ, A=FF, ÅÓÌÉ ÏÂÌÁÓÔÉ ÔÁËÏÇÏ ÒÁÚÍÅÒÁ ÎÅÔ
;
F103:   ld      a,e     ;D=1 E=3B
	cp      0FFh
	jr      z,IFFF
	push    af
	push    de
	ld      b,d             ; b=ËÏÌ-×Ï ÓÅÇÍ.
F103A:  push    bc
	call    GETSEGM         ; Å=ÔÅËÕÝÉÊ ÓÅÇÍ.
	or      a
	jr      nz,NOSPARC
	pop     bc
	inc     e
	djnz    F103A
	pop     bc              ; b=ËÏÌ-×Ï ÓÅÇÍ.
F103B:  call    SETSEGM         ; c=ÔÅËÕÝÉÊ ÓÅÇÍ.
	inc     c
	djnz    F103B
	pop     af
	ret
NOSPARC:pop     af
NOSP0:  pop     af
	pop     af
NOSP1:  xor     a
	dec     a               ; a = ff
	ret
IFFF:   ld	a, (VMEM1)
	or	a
	jr	nz, LtoU	
	dec     e               ; e=0feh..0
	jr	IFFF1
LtoU:	inc	e		; e=0..0feh 
IFFF1:	ld	a, e
	inc	a
	jr      z,NOSP1		; if a=e=0FFh
	push    de
	call    F103
	pop     de
	cp      e
	ret     z
	jr      IFFF
;
;   OÓ×ÏÂÏÄÉÔØ N ÐÏÓÌÅÄÏ×ÁÔÅÌØÎÙÈ ÓÅÇÍÅÎÔÏ×
; ÷ÈÏÄ: D=ËÏÌÉÞÅÓÔ×Ï ÓÅÇÍÅÎÔÏ×, å=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ
; ÷ÙÈÏÄ: A=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ, ÅÓÌÉ ÏÓ×ÏÂÏÖÄÅÎÉÅ ÐÒÏÛÌÏ
;        ÎÏÒÍÁÌØÎÏ, A=FF, ÅÓÌÉ ÂÙÌÁ ÏÛÉÂËÁ (ÏÓ×ÏÂÏÖÄÅÎÉÅ
;        ÓÉÓÔÅÍÎÏÇÏ ÉÌÉ ÏÔÓÕÔÓÔ×ÕÀÝÅÇÏ ïúõ)
;
F104:   ld      a,e
	push    af
	ld      b,d
F104A:  push    bc
	ld      hl,WARMMAP
	call    GETSEG1
	cp      0Eh
	jr      nc,NOSP0
	ld      c,e
	xor     a
	call    SETSEG1
	ld      e,c
	inc     e
	pop     bc
	djnz    F104A
	pop     af
	ret
;
;   105(69h) - ÉÎÓÔÁÌÌÉÒÏ×ÁÔØ ÄÒÁÊ×ÅÒ ÐÏÌØÚÏ×ÁÔÅÌÑ
; ÷ÈÏÄ: DE = ÁÄÒÅÓ ÓÔÒÏËÉ - ÏÐÉÓÁÔÅÌÑ ÄÒÁÊ×ÅÒÁ
; ÷ÙÈÏÄ: á=ÎÏÍÅÒ ÄÒÁÊ×ÅÒÁ × ÔÁÂÌÉÃÅ (1..13), ÅÓÌÉ
;        ÉÎÓÔÁÌÌÑÃÉÑ ÐÒÏÛÌÁ ÕÄÁÞÎÏ; á=FF - ÉÎÁÞÅ
; æÏÒÍÁÔ ÓÔÒÏËÉ - ÏÐÉÓÁÔÅÌÑ ÄÒÁÊ×ÅÒÁ (× ôòá):
; +0       - ÎÏÍÅÒ ÂÁÎËÁ, ÇÄÅ ÂÕÄÅÔ ÒÁÓÐ. ÄÒÁÊ×ÅÒ (FF-ìàâïê)
; +1..+8   - ÉÍÑ ÄÒÁÊ×ÅÒÁ
; +9..+10  - ÎÁÞÁÌØÎÙÊ ÁÄÒÅÓ ÄÒÁÊ×ÅÒÁ × ïúõ ôòá óòí(16 ÂÉÔ)
; +11..+12 - ÄÌÉÎÁ ÄÒÁÊ×ÅÒÁ (16 ÂÉÔ)
; +13..+14 - ÁÄÒÅÓ Ð/Ð ÚÁÈ×ÁÔÁ ×ÅËÔÏÒÏ× (× ïúõ ÄÏÐ. ÓÔÒ.)
; +15..+16 - ÁÄÒÅÓ Ð/Ð ÉÚ×ÅÝÅÎÉÑ Ï ÐÒÅÄÓÔÏÑÝÅÍ ÕÄÁÌÅÎÉÉ
; +17..+18 - ÎÁÞÁÌØÎÙÊ ÁÄÒÅÓ ÄÒÁÊ×ÅÒÁ (× ïúõ ÄÏÐ. ÓÔÒÁÎÉÃÙ)
;            ÉÌÉ 0FFFFh ÅÓÌÉ ÍÏÖÎÏ ÓÁÖÁÔØ ÎÁ ÌÀÂÏÊ ÁÄÒÅÓ
;
F105:   ld      A,WORKPAGE
	ld      hl,MBUF         ; ËÕÄÁ
	exx
	ex      af,af'
	ld      a,(RG_B)
	ld      hl,(RG_DE)      ; ÏÔËÕÄÁ
	ld      bc,40
	call    BLDIR           ; ÓÔÒÏËÁ-ÏÐÉÓÁÔÅÌØ
	ld      hl,DRVQN        ;
	ld      a,(hl)
	cp      13
	jp      nc,BADRET
	call    FINDDRV         ; hl=ÚÁÐÉÓØ Ï ÄÒÁÊ×ÅÒÅ
	inc     a
	jp      nz,BADRET       ; ÅÓÌÉ ÕÖÅ ÐÒÉÓÕÔÓÔ×ÕÅÔ
	ld      a,(EFLAG)
	or      a
	jr      nz,EEFLG
	ld      a,(DRVQN)
	inc     a
EEFLG:  ld      (DRVCODE),a
	push    hl
	ex      de,hl
	inc     de
	ld      hl,DRVNAME
	ld      bc,16           ; ÐÅÒÅÓÙÌÁÅÍ ÉÍÑ ÄÒÁÊ×ÅÒÁ
	ldir
	push    de
	ld      hl,(DSTADDR)
	ld      a,h
	ld      c,h
	inc     a
	jr      nz,NOFFFF
	ld      h,a
	ld	l,a		; ld hl,0
NOFFFF: ld      a,0fh
	and     h
	ld      h,a
	ld      de,(LENGTH)
	add     hl,de
	ex      de,hl
	ld      e,0
	call    F111
	inc     a               ; á=ÐÏÌÎÙÊ ÒÁÚÍÅÒ × ÓÅÇÍ.
	pop     de
	ld      (de),a
	push    af
	ld      a,(DRVBANK)
	ld      d,c
	ld      e,a
	call    F111            ; A=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ
	ld      e,a             ; Ó ËÁËÏÇÏ ÒÅÚÅÒ×ÉÒÏ×ÁÔØ
	pop     af
	ld      d,a             ; ÓËÏÌØËÏ ÒÅÚÅÒ×ÉÒÏ×ÁÔØ
	call    RESERVE         ; ÒÅÚÅÒ×ÉÒÕÅÍ ÍÅÓÔÏ
	inc     a               ; ×ÏÚ×Ò. ÎÁÞ ÓÅÇÍÅÎÔ ÉÌÉ FF
	jp      z,BADRET
	dec     a
	pop     hl
	push    hl
	ld      (hl),a          ; ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ ÄÒÁÊ×.
	ld      e,a
	call    F112            ; B=0  ÓÅÇÍÅÎÔ -> ÁÄÒÅÓ+ÂÁÎË
	ld      a,(DSTADDR+1)
	inc     a
	ld      a,l
	ld      l,b		; ,0
	push    af
	jr      nz,NOFFF2
	ld      (DSTADDR),hl
NOFFF2: ld      hl,(DSTADDR)
	ld      (DRVBANK),a     ; ËÕÄÁ
	exx
	ex      af,af'
	ld      hl,(SRCADDR)    ; ÏÔËÕÄÁ
	ld      a,(RG_B)
	ld      bc,(LENGTH)
	call    BLDIR           ; BC=0 ÐÅÒÅÓÌÁÌÉ ÄÒÁÊ×ÅÒ
	pop     af
	jr      nz,NOFFF3
	pop     hl
	push    hl
	ld      c,13		; bc,13
	add     hl,bc
	ld      de,DSTADDR
	call    SHIFT
	call    SHIFT
NOFFF3:
;
; úäåóø ïâòáâáôù÷áôø îáú÷áîéå äìñ äéóðåôþåòá ðòïçòáíí
;
;NTAB    EQU     0A000h         ; ôáâì.: ëïä äòáê÷.+ëìá÷éûá+óôòïëá
;NTABFLG EQU     MBUF+19
;NTABKEY EQU     MBUF+20
;NTABSTR EQU     MBUF+21
;
	LD      A,(NTABFLG)
	CP      7FH
	JR      NZ,NONTAB
	LD      HL,NTABQN
	INC     (HL)
	LD      B,(HL)
	LD      HL,NTAB-18
	LD      DE,18
ADDLOOP:ADD     HL,DE
	DJNZ    ADDLOOP
	LD      A,(EFLAG)
	OR      A
	LD      A,(DRVQN)
	JR      Z,AFTEFIX
	LD      A,0FFH
AFTEFIX:INC     A
	LD      (HL),A
	INC     HL
	EX      DE,HL
	LD      HL,NTABKEY
	LD      C,17
	LDIR

NONTAB: ld      hl,SYSVEC
	ld      de,CMPVEC
	ld      bc,3*24
	ld      a,(DRVBANK)     ; addr(DRVBANK)=addr(CMPVEC)
	ldir
	pop     hl
	push    hl
	CALL    MMDI            ; di
	call    INSCALL
	pop     hl
	ld      iy,SYSVEC       ; ÍÁÓÓÉ×-ÏÐÅÒÁÎÄ1(3*24ÂÁÊÔ)
	ld      ix,CMPVEC       ; ÍÁÓÓÉ×-ÏÐÅÒÁÎÄ2(--"--"--)
	ld      de,9
	add     hl,de           ; ÍÁÓÓÉ×-ÒÅÚÕÌØÔÁÔ (3ÂÁÊÔÁ)
	call    COMPARE
	ld      hl,DRVQN
	inc     (hl)
	LD      A,(HL)
;	JP      MEI             ; EI
;
MEI:    NOP		; DI
	RET
;
SHIFT:  ld      a,(de)
	add     a,(hl)
	ld      (hl),a
	inc     de
	inc     hl
	ld      a,(de)
	adc     a,(hl)
	ld      (hl),a
	dec     de
	inc     hl
	ret
;
; òÅÚÅÒ×ÁÔÏÒ ÐÁÍÑÔÉ. Bxod: DE (ËÁË F103) É (DRVBANK)=(MBUF)
; d=ËÏÌÉÞÅÓÔ×Ï Å=ÎÁÞÁÌØÎÙÊ ÓÅÇ. ðÒÉ BANK=0FFh - e=0Fxh
;
RESERVE:ld      a,e
	inc     a               ; ÌÀÂÏÊ ÂÁÎË, ÌÀÂÏÊ ÁÄÒÅÓ
	jp      z,F103
	ld      a,(DSTADDR+1)
	inc     a
	jr      z,ANYADDR
	ld      a,(MBUF)
	inc     a
	jp      nz,F103
WHILE:  push    de              ; ANYBANK
	call    F103
	pop     de
	inc     a
	jr      nz,EXWHILE      ; if ÕÄÁÌÏÓØ ÐÏÄÏÂÒÁÔØ ïúõ
	ld      a,e
	sub     10h
	ld      e,a
	jr      nc,WHILE
NOMEM:  xor     a               ; ÎÅ ÕÄÁÌÏÓØ ÐÏÄÏÂÒÁÔØ ïúõ
EXWHILE:dec     a
	ret
ANYADDR:push    de
	call    F103
	pop     de
	inc     a
	jr      nz,EXWHILE      ; if ÕÄÁÌÏÓØ ÐÏÄÏÂÒÁÔØ ïúõ
	dec     e
	ld      a,0fh
	and     e
	jr      z,NOMEM         ; if ÎÅ ÕÄÁÌÏÓØ ÐÏÄÏÂÒÁÔØ
	jr      ANYADDR
;
; óÒÁ×ÎÉ×ÁÔÅÌØ. ÷ÈÏÄ: (IX),(IY). ÷ÙÈÏÄ: (hl).
;
COMPARE:ld      b,24
	ld      d,0
COMP1:  ld      e,3
COMP2:  ld      a,(ix)
	xor     (iy)
	jr      nz,IFNOTEQ
	inc     ix
	inc     iy
	dec     e
	jr      nz,COMP2
	scf
IFNOTEQ:ccf
	inc     hl
	inc     hl
	rl      (hl)
	dec     hl
	rl      (hl)
	dec     hl
	rl      (hl)
	add     ix,de
	add     iy,de
	djnz    COMP1
	ret
;
INSCALL:ld      de,13
COMCALL:ld      c,(hl)          ; hl=ÁÄÒÅÓ ÏÐÉÓÁÔÅÌÑ ÄÒ., b=ÎÁÞÁÌØÎÙÊ ÓÅÇÍÅÎÔ
	add     hl,de           ; a=ÂÁÎË ÄÒÁÊ×ÅÒÁ
	ld      e,(hl)
	inc     hl
	ld      d,(hl)
	ld      h,d
	ld      l,e             ; hl=de=ÁÄÒ. Ð/Ð ÉÎÓÔÁÌÌÑÃÉÉ    !!!
	ld	b,c
	jp      BCALL           ; ÉÎÓÔÁÌÌÑÃÉÑ ×ÅËÔÏÒÏ× ÄÒ.
;
;   õÄÁÌÉÔØ ÄÒÁÊ×ÅÒ ÐÏÌØÚÏ×ÁÔÅÌÑ
; ÷ÈÏÄ: DE = ÁÄÒÅÓ ÓÔÒÏËÉ - ÉÍÅÎÉ ÄÒÁÊ×ÅÒÁ (8 ÓÉÍ×ÏÌÏ×)
; ÷ÙÈÏÄ: á=ÎÏÍÅÒ ÕÄÁÌÅÎÎÏÇÏ ÄÒÁÊ×ÅÒÁ × ÔÁÂÌÉÃÅ (1..13),
;        ÅÓÌÉ ÕÄÁÌÅÎÉÅ ÐÒÏÛÌÏ ÕÄÁÞÎÏ; á=FF, ÅÓÌÉ ÄÒÁÊ×ÅÒÁ
;
F106:   call    NAME_PR         ; ÐÏÉÓË ÉÍÅÎÉ × ÔÁÂÌÉÃÅ
	push    hl
	push    af
	push    hl
	ld      e,(hl)
	call    F112
	CALL    MMDI            ; di
	ld      a,l             ; ÂÁÎË ÄÒÁÊ×ÅÒÁ
	pop     hl
	ld      de,15
;	ld	c, SIGKILL
	call    COMCALL         ; ÏÐÏ×ÅÓÔÉÔØ ÄÒ. Ï ÕÄÁÌÅÎÉÉ
	pop     bc              ; b=ËÏÄ ÄÒÁÊ×ÅÒÁ (1..13)
	push    bc
	ld      c,0ffh
F106A:  ld      e,c
	push    bc              ; ÏÓ×ÏÂÏÖÄÅÎÉÅ ÐÁÍÑÔÉ,
	call    GETSEGM         ; ÚÁÎÉÍÁÅÍÏÊ ÄÒÁÊ×ÅÒÏÍ
	pop     bc
	cp      0Eh
	jr      nc,F106A3
	cp      b
	jr      z,F106A1
	dec     a
	jr      F106A2
F106A1: ld      a,0
F106A2: call    nc,SETSEG1
F106A3: dec     c
	jr      nz,F106A
;
; úäåóø õäáìñôø úáðéóø ÷ ôáâì. óôòïë äéóðåôþåòá ðòïçòáíí
;
	LD      A,(NTABQN)
	OR      A
	JR      Z,NONDEL
	LD      B,A
	POP     AF              ; A=ëïä äòáê÷åòá (1..13)
	PUSH    AF
	LD      HL,NTAB
	LD      DE,18
SRNTAB: CP      (HL)
	JR      Z,OKNTAB
	ADD     HL,DE
	DJNZ    SRNTAB
	JR      NONDEL
OKNTAB: PUSH    HL
	LD      HL,-17
RONTAB: ADD     HL,DE
	DJNZ    RONTAB
	LD      B,H
	LD      C,L
	POP     HL
	PUSH    HL
	ADD     HL,DE
	POP     DE
	LDIR
	LD      HL,NTABQN
	DEC     (HL)
	jr      z,NONDEL
	LD      B,(HL)
	POP     AF
	PUSH    AF              ; A=ëïä äòáê÷åòá
	LD      HL,NTAB
	LD      DE,18
FINDTAB:CP      (HL)
	JR      NC,NXTNTAB
	DEC     (HL)
NXTNTAB:ADD     HL,DE
	DJNZ    FINDTAB

NONDEL: pop     bc              ; b=ËÏÄ ÄÒÁÊ×ÅÒÁ (1..13)
	pop     de              ; de=ÁÄÒ. ÕÄÁÌÑÅÍÏÊ ÚÁÐÉÓÉ
	ld      a,(DRVQN)
	sub     b
	jr      z,F106B1
	ld      b,a             ; ÓËÏÌØËÏ ÚÁÐÉÓÅÊ ÓÄ×ÉÎÕÔØ
	xor     a
F106B:  add     a,ELSIZE
	djnz    F106B
	ld      c,a             ; ÓËÏÌØËÏ ÂÁÊÔ ÓÄ×ÉÎÕÔØ
	ld      hl,ELSIZE
	add     hl,de
	ldir                    ; ÕÄÁÌÉÌÉ ÏÄÎÕ ÚÁÐÉÓØ
F106B1: ld      hl,DRVQN
	dec     (hl)            ; ÄÒÁÊ×ÅÒÏ× ÓÔÁÌÏ ÎÁ 1 ÍÅÎØÛÅ
	ld      a,(hl)
	ld      hl,RESVEC
	ld      de,SYSVEC
	ld      bc,3*24
	ldir                    ; ×ÅËÔÏÒÁ ÄÏ ÚÁÇÒÕÚËÉ ÄÒ-Ï×
	or      a
	jr      z,EXF106
	ld      b,a
	ld      hl,DRIVERS
F106C:  push    bc              ; ÐÅÒÅÉÎÓÔÁÌÌÉÒÕÅÍ ×ÓÅ
	push    hl              ; ÄÒÁÊ×ÅÒÁ ÐÏÓÌÅ ÕÄÁÌÑÅÍÏÇÏ
	ld      e,(hl)          ; ÎÁÞ. ÓÅÇÍÅÎÔ
	call    F112
	ld      a,l             ; a=ÂÁÎË ÓÌÅÄ. ÄÒÁÊ×ÅÒÁ
	pop     hl
	push    hl              ; hl=ÏÐÉÓÁÔÅÌØ ÓÌÅÄ. ÄÒÁÊ×.
	call    INSCALL
	pop     hl
	ld      de,ELSIZE
	add     hl,de
	pop     bc
	djnz    F106C
EXF106:
	JP      MEI             ;ei
;
;   ðÏÌÕÞÉÔØ ÓÐÉÓÏË ÄÒÁÊ×ÅÒÏ×
; ÷ÙÈÏÄ: × ÂÕÆÅÒ ÏÂÍÅÎÁ ÐÏÍÅÝÁÅÔÓÑ ÔÁÂÌÉÃÁ ÉÚ 0..13
;        ÜÌÅÍÅÎÔÏ× - ÚÁÇÏÌÏ×ËÏ× ÚÁÐÉÓÅÊ Ï ÄÒÁÊ×ÅÒÅ
;        á=0..13 - ËÏÌÉÞÅÓÔ×Ï ÜÔÉÈ ÜÌÅÍÅÎÔÏ×
;
F107:   ld      hl,(REWADDR)
	ld      a,(REWBANK)             ; ËÕÄÁ
	exx
	ex      af,af'
	ld      hl,DRIVERS              ; ÏÔËÕÄÁ
	ld      bc,13*ELSIZE            ; ÓËÏÌØËÏ
BLDIRA1:call    BLDIRF1
	ld      a,(DRVQN)
	ret
;
;   ðÏÉÓË ÄÒÁÊ×ÅÒÁ ÐÏ ÉÍÅÎÉ ÄÒÁÊ×ÅÒÁ Ó ÍÅÔÁÓÉÍ×ÏÌÁÍÉ
; ÷ÈÏÄ: DE=ÁÄÒÅÓ ÓÔÒÏËÉ - ÉÍÅÎÉ ÄÒÁÊ×ÅÒÁ (8 ÓÉÍ×ÏÌÏ×)
; ÷ÙÈÏÄ: × ÂÕÆÅÒÅ ÏÂÍÅÎÁ - ÚÁÇÏÌÏ×ÏË ÄÒÁÊ×ÅÒÁ,
;        ÅÓÌÉ ÄÒÁÊ×ÅÒ Ó ÔÁËÉÍ ÛÁÂÌÏÎÏÍ ÅÓÔØ;
;        á=FF ÅÓÌÉ ÄÒÁÊ×ÅÒÁ Ó ÔÁËÉÍ ÎÏÍÅÒÏÍ ÎÅÔ.
;
F108:   ld      hl,(REWADDR)
	ld      a,(REWBANK)     ; ËÕÄÁ
	push    de
	exx
	ex      af,af'
	pop     de
	call    NAME_PR
	ld      bc,ELSIZE
	push    af             ; ÏÔËÕÄÁ
	call    BLDIRF1
	pop     af
	ret
;
;   ðÏÌÕÞÉÔØ ËÁÒÔÕ ÐÁÍÑÔÉ
; ÷ÙÈÏÄ: × ÂÕÆÅÒ ÏÂÍÅÎÁ ÐÏÍÅÝÁÅÔÓÑ 128-ÂÁÊÔÏ×ÁÑ ËÁÒÔÁ ÐÁÍ.
;
F109:   ld      a,(REWBANK)
	ld      hl,(REWADDR)    ; ËÕÄÁ
	exx
	ex      af,af'
	ld      hl,MAP          ; ÏÔËÕÄÁ
	ld      bc,128          ; ÓËÏÌØËÏ
	jr      BLDIRA1
;
; ðÏÉÓË ÄÒÁÊ×ÅÒÁ ÐÏ ÉÍÅÎÉ × MBUF+1. ÷ÙÈÏÄ A=1..13 ÉÌÉ 0FFh
;   hl=ÁÄÒÅÓ ÚÁÐÉÓÉ Ï ÄÒÁÊ×ÅÒÅ (ÅÓÌÉ ÎÁÊÄÅÎ)
;
FINDDRV:ld      hl,DRVNAME
	ld      b,8
FIND@:  ld      a,(hl)
	cp      '`'
	jr      c,FIND@1
	and     5fh
	ld      (hl),a
FIND@1: inc     hl
	djnz    FIND@
	ld      a,(DRVQN)
	or      a
	ld      a,0FFh
	ld      hl,DRIVERS
	ret     z
	ld      c,1
FINDA:  push    hl              ; hl=ÎÁÞÁÌÏ ÚÁÐÉÓÉ Ï ÄÒÁÊ×.
	ld      de,DRVNAME      ; de=MBUF+1
	ld      b,8
FINDB:  inc     hl
	ld      a,(de)
	cp      '?'
	jr      z,FINDC
	cp      (hl)
	jr      nz,NOTEQ
FINDC:  inc     de
	djnz    FINDB
	ld      a,c
	pop     hl
	ret
NOTEQ:  pop     hl
	ld      de,ELSIZE
	add     hl,de
	ld      a,(DRVQN)
	cp      c
	ld      a,0FFh
	RET     Z
	inc     c
	jr      FINDA
;
;   ðÏÌÕÞÉÔØ ÉÎÆÏÒÍÁÃÉÀ Ï ÐÁÍÑÔÉ
; ÷ÙÈÏÄ: H=ÒÁÚÍÅÒ ×ÓÅÇÏ ÉÓÐÒÁ×ÎÏÇÏ ïúõ × ÓÅÇÍÅÎÔÁÈ
;        L=ÒÁÚÍÅÒ Ó×ÏÂÏÄÎÏÇÏ ïúõ × ÓÅÇÍÅÎÔÁÈ
;
F110:   ld      hl,0
	ld      b,l
F110A:  push    bc
	push    hl
	ld      e,b
	call    GETSEGM
	pop     hl
	cp      0Fh
	jr      z,F110B
	inc     h
	or      a
	jr      nz,F110B
	inc     l
F110B:  pop     bc
	djnz    F110A
	ret
;
;   ðÅÒÅÓÞÅÔ ÆÉÚ. ÁÄÒÅÓÁ × ÎÏÍÅÒ ÓÅÇÍÅÎÔÁ
; ÷ÈÏÄ: DE = ÓÔÁÒÛÉÊ ÂÁÊÔ ÁÄÒÅÓÁ (D) + ÂÁÎË (E)
; ÷ÙÈÏÄ: A = ÎÏÍÅÒ ÓÅÇÍÅÎÔÁ
;
F111:   ld      b,4
	ld      a,e
F111A:  sla     d
	rla
	djnz    F111A
	ret
;
;   ðÅÒÅÓÞÅÔ ÎÏÍÅÒÁ ÓÅÇÍÅÎÔÁ × ÆÉÚ. ÁÄÒÅÓ
; ÷ÈÏÄ: E = ÎÏÍÅÒ ÓÅÇÍÅÎÔÁ
; ÷ÙÈÏÄ: HL = ÓÔÁÒÛÉÊ ÂÁÊÔ ÁÄÒÅÓÁ (H) + ÂÁÎË (L)
;
F112:   ld      b,4
	ld      l,e
	ld      h,0
F112A:  srl     l
	rr      h
	djnz    F112A
	ret
;
;   ÷ÏÓÓÔÁÎÏ×ÌÅÎÉÅ ÓÉÓÔÅÍÎÏÇÏ É ÂÉÔÏÇÏ ïúõ
; ÷ÏÓÓÔÁÎÁ×ÌÉ×ÁÅÔ ÏÔÍÅÔËÕ ÓÉÓÔÅÍÎÏÇÏ É ÏÔÓÕÔÓÔ×ÕÀÝÅÇÏ ïúõ ×
; ËÁÒÔÅ ÐÁÍÑÔÉ ÔÁËÏÊ, ËÁËÏÊ ÏÎÁ ÂÙÌÁ ÐÒÉ ÓÔÁÒÔÅ åíí.
;
F113:   ld      b,0FFh
F113A:  push    bc
	ld      e,b
	ld      hl,WARMMAP
	call    GETSEG1         ; ÓÅÇÍÅÎÔ × ÈÏÌÏÄ. ËÁÒÔÅ
	cp      0Eh
	jr      nc,F113B
	call    GETSEGM         ; ÓÅÇÍÅÎÔ × ÓÉÓÔ. ËÁÒÔÅ
	cp      0Eh
	jr      c,F113B
	xor     a
	ld      c,e
	call    SETSEG1         ; ÏÓ×ÏÂÏÄÉÔØ ÓÅÇÍÅÎÔ
F113B:  pop     bc
	djnz    F113A
	ret
;
; ðÏÍÅÎÑÔØ ÍÅÓÔÁÍÉ ÓÏÄÅÒÖÉÍÏÅ Ä×ÕÈ ÓÅÇÍÅÎÔÏ×.
; ÷ÈÏÄ: D,E - ÎÏÍÅÒÁ ÓÅÇÍÅÎÔÏ×.
;
F114:   ld      b,64            ; 64 ÃÉËÌÁ
	ld      hl,0
	ld      (CALADDR),hl    ; (CALADDR)=0
F114A:  push    bc
	ld      A,WORKPAGE	; 1
	ld      hl,MBUF         ; ËÕÄÁ
	ex      af,af'
	ld      a,(RG_DE)
	call    F114SUB         ; ÏÔËÕÄÁ & ÓËÏÌØËÏ
	push    hl
	push    af
	call    BLDIR           ; E-seg -> MBUF

	pop     af
	pop     hl              ; ËÕÄÁ (E-seg)
	ex      af,af'
	ld      a,(RG_DE+1)
	call    F114SUB         ; ÏÔËÕÄÁ & ÓËÏÌØËÏ
	push    bc
	push    hl
	push    af
	call    BLDIR           ; D-seg -> E-seg

	pop     af
	pop     hl              ; ËÕÄÁ (D-seg)
	exx
	ex      af,af'
	pop     bc              ; bc=64
	ld      hl,(CALADDR)
	add     hl,bc
	ld      (CALADDR),hl    ; (CALADDR)=(CALADDR+16)
	ld      hl,MBUF
	call    BLDIRA1         ; MBUF -> D-seg
	pop     bc
	djnz    F114A
	ret
;
F114SUB:exx
	ld      e,a
	call    F112		; B=0
	ld      a,l
	ld      l,b		; ,0    ; ÁÄÒÅÓ É ÂÁÎË ÓÅÇÍÅÎÔÁ
	ld      de,(CALADDR)
	add     hl,de           ; ÏÔËÕÄÁ
	ld      c,64            ; bc,64   ÓËÏÌØËÏ
	ret
;
;   ðÏÌÕÞÉÔØ ÓÐÉÓÏË ÄÉÓÐÅÔÞÅÒÁ ÐÒÏÇÒÁÍÍ
; ÷ÙÈÏÄ: ÐÏ (DE) ÐÏÍÅÝÁÅÔÓÑ ÔÁÂÌÉÃÁ ÜÌÅÍÅÎÔÏ×
;        á=0..ÈÈ - ËÏÌÉÞÅÓÔ×Ï ÜÔÉÈ ÜÌÅÍÅÎÔÏ×
;
F115:   EX      DE,HL
;        ld      a,(RG_B)             ; ËÕÄÁ
	exx
	ex      af,af'
	ld      a,(NTABQN)
	OR      A
	RET     Z
	PUSH    AF
	LD      B,A
	LD      HL,0
	LD      DE,18
ADDPRO: ADD     HL,DE
	DJNZ    ADDPRO
	LD      B,H
	LD      C,L
	ld      hl,NTAB                 ; ÏÔËÕÄÁ
	call    BLDIRA1
	POP     AF
	RET
;
GETSEGM:ld      hl,MAP
GETSEG1:ld      c,e             ; ÷ÈÏÄ - ÒÅÇ. E
	srl     c               ;
	push    af
	ld      a,0f0h
	jr      nc,GETS1
	ld      a,0fh
GETS1:  ld      b,0
	add     hl,bc
	and     (hl)
	ld      c,a
	pop     af
	ld      a,c
	ret     c
	rrca
	rrca
	rrca
	rrca
	ret
;
SETSEGM:ld      a,(DRVCODE)
SETSEG1:ld      hl,MAP
	ld      e,c             ; ÷ÈÏÄ - ÒÅÇ. C
	srl     e
	push    af
	ld      a,0fh
	jr      nc,SETS0
	ld      a,0f0h
SETS0:  ld      d,0
	add     hl,de
	and     (hl)
	ld      e,a
	pop     af
	jr      c,SETS1
	rlca
	rlca
	rlca
	rlca
SETS1:  or      e
	ld      (hl),a
	ret
;
NAME_PR:ld      hl,DRVNAME
	ld      A,WORKPAGE	; 1             ; ËÕÄÁ
	push    de
	exx
	ex      af,af'
	pop     hl
	ld      a,(RG_B)        ; ÏÔËÕÄÁ
	ld      bc,8            ; ÓËÏÌØËÏ
	call    BLDIR           ; ÐÅÒÅÓÌÁÌÉ ÉÍÑ
	call    FINDDRV         ; ÐÏÉÓË ÐÏ ÉÍÅÎÉ -
	cp      0FFh            ; ÕÓÔÁÎÁ×ÌÉ×ÁÅÔ hl
	ret     nz
BADRET: xor     a
	ld      h,a
	ld      l,a             ; hl=0
	dec     a               ; a=ff
RETURN: ld      de,(RG_DE)
	ld      sp,(RG_SP)
	ret

ush    de
	push 